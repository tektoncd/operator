apiVersion: v1
data:
  POSTGRES_DB: tekton-results
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: tekton-results-postgres
    app.kubernetes.io/part-of: tekton-results
  name: tekton-results-postgres
  namespace: tekton-pipelines
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: tekton-results-postgres
    app.kubernetes.io/part-of: tekton-results
  name: postgres-upgrade-scripts
  namespace: tekton-pipelines
data:
  postgres-wrapper.sh: |
    #!/bin/bash
    set -eu

    PGDATA="${PGDATA:-/var/lib/pgsql/data}"
    CURRENT_VERSION="15"
    UPGRADE_FROM_VERSION="13"
    PG_VERSION_FILE="$PGDATA/userdata/PG_VERSION"

    echo "=== PostgreSQL Container Starting ==="

    # Check if data directory exists with previous version
    if [ -f "$PG_VERSION_FILE" ]; then
        DATA_VERSION=$(cat "$PG_VERSION_FILE")
        echo "Data directory PostgreSQL version: $DATA_VERSION"

        # Check if upgrade is needed from version 13 to 15
        if [ "$DATA_VERSION" = "$UPGRADE_FROM_VERSION" ]; then
            echo "========================================="
            echo "PostgreSQL Upgrade Mode Activated"
            echo "Upgrading from PostgreSQL $UPGRADE_FROM_VERSION to PostgreSQL $CURRENT_VERSION"
            echo "========================================="

            # Set the POSTGRESQL_UPGRADE environment variable
            # The sclorg PostgreSQL container will detect this and run pg_upgrade
            export POSTGRESQL_UPGRADE="copy"

            echo "Starting PostgreSQL with POSTGRESQL_UPGRADE=copy"
        elif [ "$DATA_VERSION" = "$CURRENT_VERSION" ]; then
            echo "PostgreSQL data is already version $CURRENT_VERSION - starting normally"
        else
            echo "WARNING: Unexpected PostgreSQL version $DATA_VERSION"
        fi
    else
        echo "No existing data found - PostgreSQL will initialize new database"
    fi

    # Execute the standard PostgreSQL container entrypoint
    exec run-postgresql
immutable: true
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: tekton-results-postgres
    app.kubernetes.io/part-of: tekton-results
  name: tekton-results-postgres-service
  namespace: tekton-pipelines
spec:
  ports:
  - name: postgres
    port: 5432
  selector:
    app.kubernetes.io/name: tekton-results-postgres
  type: NodePort
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/name: tekton-results-postgres
    app.kubernetes.io/part-of: tekton-results
  name: tekton-results-postgres
  namespace: tekton-pipelines
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: tekton-results-postgres
  serviceName: postgres
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tekton-results-postgres
    spec:
      containers:
        - env:
            - name: PGDATA
              value: /var/lib/pgsql/data
            - name: POSTGRESQL_DATABASE
              valueFrom:
                configMapKeyRef:
                  key: POSTGRES_DB
                  name: tekton-results-postgres
            - name: POSTGRESQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: POSTGRES_PASSWORD
                  name: tekton-results-postgres
            - name: POSTGRESQL_USER
              valueFrom:
                secretKeyRef:
                  key: POSTGRES_USER
                  name: tekton-results-postgres
          image: registry.redhat.io/rhel9/postgresql-15@sha256:90ec347a35ab8a5d530c8d09f5347b13cc71df04f3b994bfa8b1a409b1171d59
          name: postgres
          ports:
            - containerPort: 5432
              name: postgredb
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              add:
                - NET_BIND_SERVICE
              drop:
                - ALL
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          volumeMounts:
            - mountPath: /var/lib/pgsql/data
              name: postgredb
  volumeClaimTemplates:
    - metadata:
        name: postgredb
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
